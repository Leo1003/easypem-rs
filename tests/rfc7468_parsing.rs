extern crate easypem;
#[macro_use]
extern crate hex_literal;

use easypem::*;
use std::fs;
use std::path::{Path, PathBuf};
use std::str::from_utf8;

fn locate_test_files<P: AsRef<Path>>(path: P) -> PathBuf {
    let mut abspath = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    abspath.push("tests/assets/");
    abspath.push(path);
    abspath
}

fn parse_file<P: AsRef<Path>>(testfile: P, label: &str, data: &[u8]) {
    let fpath = locate_test_files(testfile);

    let pemtext = fs::read_to_string(fpath).unwrap();
    let pem = pemtext.parse::<PemMessage>().unwrap();

    assert_eq!(&pem.label, label);
    assert!(pem.headers.is_empty());
    assert_eq!(pem.content.as_slice(), data);
}

#[test]
fn parse_certificate() {
    parse_file(
        "certificate.txt",
        CERTIFICATE_LABEL,
        &hex!(
            "
        3082022c308201d2a003020102020100300a06082a8648ce3d040302307d310b
        3009060355040613024245310f300d060355040a1306476e75544c5331253023
        060355040b131c476e75544c5320636572746966696361746520617574686f72
        697479310f300d060355040813064c657576656e312530230603550403131c47
        6e75544c5320636572746966696361746520617574686f72697479301e170d31
        31303532333230333832315a170d3132313232323037343135315a307d310b30
        09060355040613024245310f300d060355040a1306476e75544c533125302306
        0355040b131c476e75544c5320636572746966696361746520617574686f7269
        7479310f300d060355040813064c657576656e312530230603550403131c476e
        75544c5320636572746966696361746520617574686f72697479305930130607
        2a8648ce3d020106082a8648ce3d0301070342000452d88d238ae367d78636b1
        200b097dc8c9baa220952fc54a63fa835fce782f8ff362cafdb7f780569d6e17
        b90e114c48b2c0af3b591716306809079917fedda7a3433041300f0603551d13
        0101ff040530030101ff300f0603551d0f0101ff04050303070600301d060355
        1d0e04160414f0b481fe9812bfb528b9644003cbcc1f664e2803300a06082a86
        48ce3d0403020348003045022031aec03d4a3f21be8517fcf0c7b231072a3856
        43d136d595e17e52c0064387a7022100978c0eb83c0a41afaea5cf067ed5c4d8
        2fffe262803410ba22dd35814693229a"
        ),
    );
}

#[test]
fn parse_crl() {
    parse_file(
        "crl.txt",
        CRL_LABEL,
        &hex!(
            "
        308201f43082015f020101300b06092a864886f70d0101053082010831173015
        060355040a130e566572695369676e2c20496e632e311f301d060355040b1316
        566572695369676e205472757374204e6574776f726b31463044060355040b13
        3d7777772e766572697369676e2e636f6d2f7265706f7369746f72792f525041
        20496e636f72702e206279205265662e2c4c4941422e4c54442863293938311e
        301c060355040b1315506572736f6e61204e6f742056616c6964617465643126
        3024060355040b131d4469676974616c20494420436c6173732031202d204e65
        747363617065311830160603550403140f53696d6f6e204a6f73656673736f6e
        3122302006092a864886f70d010901161373696d6f6e406a6f73656673736f6e
        2e6f7267170d3036313232373038303233345a170d3037303230373038303233
        355a3023302102102e103703df46859d7a550da659618538170d303631323237
        3038303233345a300b06092a864886f70d010105038181003d335fe27686471c
        35baead439f920a2fc9d72e03c6707bf523f95ed4c368f6dd688464310791e71
        549113c063cd9f47a129a2be1a1e05726fee72fa778a37d2a7da63c5e228ae9f
        e6b8a36e828c9d2902ba2308bd69f13d32ca2f57c6fc9cfdecda67df07888c8f
        7370c630d47ea149928ca6748c884062678bc5a3c77d0c11"
        ),
    );
}

#[test]
fn parse_request() {
    parse_file(
        "cert_req.txt",
        CERTREQ_LABEL,
        &hex!(
            "
        3082015830820107020100304e310b3009060355040613025345312730250603
        55040a131e53696d6f6e204a6f73656673736f6e20446174616b6f6e73756c74
        204142311630140603550403130d6a6f73656673736f6e2e6f7267304e301006
        072a8648ce3d020106052b81040021033a0004b2cf4a4b9763497ae8c6f1549d
        cca2de45085baa41f9fa753b3ef7f08c10e952c157a3efbb63e7a923f51fe3f5
        0f8b7f2b17f053bd239a77a062306006092a864886f70d01090e315330513018
        0603551d110411300f820d6a6f73656673736f6e2e6f7267300c0603551d1301
        01ff04023000300f0603551d0f0101ff0405030307a00030160603551d250101
        ff040c300a06082b06010505070301300a06082a8648ce3d040302033f00303c
        021c41bdf8713c57db05bb04d4da0598251ccce140a44b90554c3764febd021c
        165e4ddd81252c2a7bb02f983f7ed01874441cf01f2301c9ee3ab7d4"
        ),
    );
}

#[test]
fn parse_pkcs7() {
    parse_file(
        "pkcs7.txt",
        PKCS7_LABEL,
        &hex!(
            "
        3081e3060b2a864886f70d0109100117a081d33081d00201003161a35f020100
        a01b06092a864886f70d01050c300e0408b7eb23a76bd2051602021388302306
        0b2a864886f70d0109100309301406082a864886f70d03070408669102456b73
        bb99041830a37ab5d8f28750ec4104ae899926f02eae4fe3f3522ba330520609
        2a864886f70d0107013033060b2a864886f70d010910030f3024301406082a86
        4886f70d03070408d2d081714d3d9f11300c06082b0601050508010205008010
        3ac60661415d007d1135cd69e156ca1004143365e8f0f30706861da8472c6d3a
        1d942140647e"
        ),
    );
}

#[test]
fn parse_cms() {
    parse_file(
        "cms.txt",
        CMS_LABEL,
        &hex!(
            "
        308183060b2a864886f70d0109100109a0743072020100300d060b2a864886f7
        0d0109100308305e06092a864886f70d010701a051044f789c73cecf2b49cd2b
        d10da92c48b5522849ad28d12fc849ccccb35648ce482c2a4e2db10d0dd6750c
        76f6f4e4e5e2e572cf2c4b5588cc2f2d52f0484d2c2a514854702a4a4dcc0649
        01009bf4171d"
        ),
    );
}

#[test]
fn parse_privkey() {
    parse_file(
        "privatekey.txt",
        PRIVKEY_LABEL,
        &hex!(
            "
        308184020100301006072a8648ce3d020106052b8104000a046d306b02010104
        2055c07f50d3f16a547dcc36008d021f8e88d40e242e1a7489ac5104cd93d3ff
        dda144034200049ced426d82717f69ba9633ad13dd734913306fe5ecfd4ddc0a
        1f433ac69336abee77c26b0dfde60b760b638017770c1987b4f8a50a48852025
        f2680f33f4b909"
        ),
    );
}

#[test]
fn parse_encprivkey() {
    parse_file(
        "enc_privatekey.txt",
        ENC_PRIVKEY_LABEL,
        &hex!(
            "
        3081cd304006092a864886f70d01050d3033301b06092a864886f70d01050c30
        0e040821848080e93ff9d502020800301406082a864886f70d0307040810b10e
        0bc8e7d8bd048188637080aa530d06069223942289654d2772297cb9c4884b16
        674248a07c9198a2bff9cafd40f2e7cf12269b44d1f6ce09ac6dc28a5cd35af6
        f48c8bdb1b786ed33c853eb6a83246a9f1e4735ac22f0b94957a5f824a3a12da
        6552f3b7328e50feb71ae6ad739560313e79380c2dbacb9ac5a1dd09024d1b45
        402ee4d0d3735074d5f72183c1fa8c6f"
        ),
    );
}

#[test]
fn parse_attrcert() {
    parse_file(
        "attr_cert.txt",
        ATTRCERT_LABEL,
        &hex!(
            "
        3082022b30820194020101308197a08194308189a48186308183310b30090603
        550406130255533111300f06035504080c084e657720596f726b311430120603
        5504070c0b53746f6e792042726f6f6b310f300d060355040a0c064353453539
        32313a303806035504030c3153636f7474205374616c6c65722f656d61696c41
        6464726573733d737374616c6c65724069632e73756e7973622e656475020601
        15ab814512a0818c308189a48186308183310b30090603550406130255533111
        300f06035504080c084e657720596f726b3114301206035504070c0b53746f6e
        792042726f6f6b310f300d060355040a0c06435345353932313a303806035504
        030c3153636f7474205374616c6c65722f656d61696c416464726573733d7373
        74616c6c65724069632e73756e7973622e656475300d06092a864886f70d0101
        05050002060115ab81454a3022180f33393037303230313035303030305a180f
        33393131303133313035303030305a302b3029060355184831223020861e6874
        74703a2f2f696465726173686e2e6f72672f696e6465782e68746d6c300d0609
        2a864886f70d0101050500038181001533d6b114f5d7a3310571eaf4e9b8fd30
        20410902ed00ced95dc663731caf6bbc420439ad6573d8525b877f939c58f273
        e573eeb3fc52f70060b653377e574828dc8d3bc46c329e8e731f8f1a520273bc
        e96621a60982e5eb89401063cefdbb304a696e6a4d5a648b6d78f79300778926
        cf22ccd279691dd671ddc0e602f3b5"
        ),
    );
}

#[test]
fn parse_pubkey() {
    parse_file(
        "publickey.txt",
        PUBKEY_LABEL,
        &hex!(
            "
        3076301006072a8648ce3d020106052b81040022036200049f52e5c0b37f2816
        104551fa1df20c4f37c4a89395ced2de90b721a76862efc70268c63cd4506562
        cf09f65ee4adcf8ce1a05e0866058db6be8625edb4958f2fbc9d944fb9506e14
        3649f7128b3c122641ca2f4356cc9fcbd79e8e1fbc017829"
        ),
    );
}
